<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Шаблон Saga</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://picture-search.skywork.ai/aippt/static/tailwindcss.com"></script>

<style>
    /* Стиль wrapper як у попередніх слайдах */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #F3F4F6;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: sans-serif;
    }
    .wrapper {
      width: 1280px;
      height: 720px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .slide {
        width: 100%;
        height: 100%;
        position: relative;
        background: white;
        display: flex;
        flex-direction: column;
    }

    .title-bar {
        background: linear-gradient(90deg, #3B82F6 0%, #93C5FD 100%);
    }

    .saga-node {
        fill: white;
        stroke-width: 2px;
        filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.2));
    }
    .saga-node-text {
        font-size: 14px;
        font-family: sans-serif;
        text-anchor: middle;
        dominant-baseline: middle;
    }
    .saga-link { fill: none; stroke-width: 2px; }
    .success-path { stroke: #10B981; }
    .compensation-path { stroke: #EF4444; stroke-dasharray: 5,5; }

    .node-icon { font-size: 24px; }

    .page-number {
        position: absolute;
        bottom: 20px;
        right: 20px;
        font-size: 14px;
        color: #6B7280;
        visibility: hidden;
    }
</style>
</head>

<body>
<div class="wrapper">
<div class="slide flex flex-col">

<!-- Title bar -->
<div class="title-bar py-4 px-10 text-white">
  <h1 class="text-3xl font-bold">Шаблон Saga</h1>
</div>

<!-- Main content -->
<div class="flex-1 p-8 flex">

  <!-- Left side: Explanation -->
  <div class="w-1/3 pr-6">
    <h2 class="text-xl text-gray-700 mb-4 font-semibold">Асинхронний підхід до розподілених транзакцій</h2>

    <div class="mb-4">
      <p class="text-gray-600 mb-2">
        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
        Розбиває транзакцію на серію локальних операцій у різних сервісах
      </p>
    </div>

    <div class="mb-4">
      <p class="text-gray-600 mb-2">
        <i class="fas fa-cogs text-blue-500 mr-2"></i>
        Кожна локальна транзакція змінює свої дані та публікує подію
      </p>
    </div>

    <div class="mb-4">
      <p class="text-gray-600 mb-2">
        <i class="fas fa-undo text-blue-500 mr-2"></i>
        У разі помилки запускаються компенсуючі операції
      </p>
    </div>

    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mt-6">
      <h3 class="text-lg font-semibold text-blue-700 mb-2">Переваги</h3>
      <ul class="text-gray-600 list-disc ml-5">
        <li>Краща масштабованість</li>
        <li>Стійкість до часткових збоїв</li>
        <li>Слабке зв’язування між сервісами</li>
      </ul>
    </div>
  </div>

  <!-- Right side: Saga Flowchart -->
  <div class="w-2/3 pl-6">
      <div class="w-full h-96 bg-white rounded-lg shadow-md p-4" id="saga-flowchart"></div>

      <div class="flex justify-center mt-4 space-x-8">
        <div class="flex items-center">
          <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
          <span class="text-sm text-gray-600">Основний шлях</span>
        </div>
        <div class="flex items-center">
          <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
          <span class="text-sm text-gray-600">Компенсації</span>
        </div>
      </div>
  </div>
</div>

<div class="page-number">11/12</div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    const nodes = [
        { id: "start", label: "Початок бронювання", x: 150, y: 50, icon: "fa-play-circle", color: "#3B82F6" },
        { id: "bookFlight", label: "Бронювання рейсу", x: 150, y: 150, icon: "fa-plane", color: "#3B82F6" },
        { id: "bookHotel", label: "Бронювання готелю", x: 300, y: 150, icon: "fa-hotel", color: "#3B82F6" },
        { id: "processPayment", label: "Опрацювання оплати", x: 450, y: 150, icon: "fa-credit-card", color: "#3B82F6" },
        { id: "bookingConfirmed", label: "Підтвердження", x: 600, y: 150, icon: "fa-check-circle", color: "#10B981" },
        { id: "compensateHotel", label: "Скасувати готель", x: 300, y: 250, icon: "fa-hotel", color: "#EF4444" },
        { id: "compensateFlight", label: "Скасувати рейс", x: 150, y: 250, icon: "fa-plane", color: "#EF4444" }
    ];

    const links = [
        { source: "start", target: "bookFlight", type: "success" },
        { source: "bookFlight", target: "bookHotel", type: "success" },
        { source: "bookHotel", target: "processPayment", type: "success" },
        { source: "processPayment", target: "bookingConfirmed", type: "success" },
        { source: "bookFlight", target: "compensateHotel", type: "compensation" },
        { source: "bookHotel", target: "compensateFlight", type: "compensation" },
        { source: "compensateHotel", target: "compensateFlight", type: "compensation" }
    ];

    const svg = d3.select("#saga-flowchart")
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("viewBox", "0 0 700 300");

    svg.selectAll(".saga-link")
        .data(links)
        .enter()
        .append("path")
        .attr("class", d => `saga-link ${d.type === "success" ? "success-path" : "compensation-path"}`)
        .attr("d", d => {
            const s = nodes.find(n => n.id === d.source);
            const t = nodes.find(n => n.id === d.target);

            if (d.type === "compensation") {
                return `M${s.x},${s.y} C${s.x},${(s.y + t.y)/2} ${t.x},${(s.y + t.y)/2} ${t.x},${t.y}`;
            }

            return `M${s.x},${s.y} L${t.x},${t.y}`;
        });

    svg.selectAll(".saga-node-group")
        .data(nodes)
        .enter()
        .append("g")
        .attr("class", "saga-node-group")
        .attr("transform", d => `translate(${d.x}, ${d.y})`)
        .each(function(d) {
            const g = d3.select(this);

            g.append("circle")
              .attr("class", "saga-node")
              .attr("r", 30)
              .attr("fill", d.color)
              .attr("stroke", d.color);

            g.append("text")
              .attr("class", "node-icon")
              .attr("text-anchor", "middle")
              .attr("dominant-baseline", "central")
              .attr("fill", "white")
              .attr("font-family", "FontAwesome")
              .text(() => "");

            g.append("text")
  .attr("class", "saga-node-text")
  .attr("y", 45)
  .attr("fill", "#4B5563")
  .attr("stroke", "white")
  .attr("stroke-width", "5px")
  .attr("paint-order", "stroke")
  .attr("stroke-linejoin", "round")
  .text(d.label);

        });

    svg.append("text")
        .attr("x", 250).attr("y", 110)
        .attr("fill", "#4B5563")
        .attr("font-style", "italic")
        .attr("font-size", "12px")
        .text("Подія FlightBooked");

    svg.append("text")
        .attr("x", 390).attr("y", 110)
        .attr("fill", "#4B5563")
        .attr("font-style", "italic")
        .attr("font-size", "12px")
        .text("Подія HotelBooked");

    svg.append("text")
        .attr("x", 530).attr("y", 110)
        .attr("fill", "#4B5563")
        .attr("font-style", "italic")
        .attr("font-size", "12px")
        .text("Подія PaymentProcessed");
});
</script>

</body>
</html>
